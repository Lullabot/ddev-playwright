#!/bin/bash
# Install Playwright npm/yarn deps and trigger Playwright-enabled web rebuild.
# Usage: ddev playwright-install [--pm npm|yarn]

set -euo pipefail

PLAYWRIGHT_TEST_DIR="${PLAYWRIGHT_TEST_DIR:-test/playwright}"
PM="npm"

while [ "$#" -gt 0 ]; do
  case "$1" in
    --pm)
      shift
      PM="$1"
      shift
      ;;
    --pm=*)
      PM="${1#*=}"
      shift
      ;;
    *)
      echo "Unknown argument: $1"
      exit 1
      ;;
  esac
done

if [ ! -f "$PLAYWRIGHT_TEST_DIR/package.json" ]; then
  echo "No package.json found at $PLAYWRIGHT_TEST_DIR. Create one or run 'ddev playwright-init --pm $PM' first."
  exit 1
fi

# Copy .env.example to .env if present.
if [ -f "$PLAYWRIGHT_TEST_DIR/.env.example" ] && [ ! -f "$PLAYWRIGHT_TEST_DIR/.env" ]; then
  echo "Copying .env.example to .env"
  cp "$PLAYWRIGHT_TEST_DIR/.env.example" "$PLAYWRIGHT_TEST_DIR/.env"
fi

echo "Installing Playwright dependencies using $PM in $PLAYWRIGHT_TEST_DIR"
if [ "$PM" = "npm" ]; then
  ddev exec -d /var/www/html/"$PLAYWRIGHT_TEST_DIR" npm ci
else
  ddev exec -d /var/www/html/"$PLAYWRIGHT_TEST_DIR" yarn
fi

# Trigger web rebuild to include Playwright browsers (existing command does this).
echo "Triggering Playwright-enabled web rebuild..."
ddev install-playwright

echo "Done."